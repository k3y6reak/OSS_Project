# 3_Advanced topics

## Intermediate Representation

일반적인 x86 뿐만 아니라 MIPS, ARM 및 PowerPC같은 다양한 CPU 아키텍쳐의 기계어 코드를 분석하고 실행하기 위해 angr는 수행되는 기본 동작의 대부분의 분석을 수행합니다. angr의 IR, VEX(Valgrind에서 VEX를 따옴)를 이해하면서 매우 빠른 정적분석을 할 수 있고, angr이 작동하는 방식을 더 잘 이해할 수 있습니다.

VEX IR은 다른 아키텍처를 다룰 때 몇 가지 아키텍처들의 차이를 추상화하여 모든 아키텍처에 대해 단일 분석을 수행할 수 있도록 합니다.

* **Register names**. 레지스터의 크기와 이름은 아키텍처마다 다르지만 최신 CPU들은 보통 공통적인 아키텍처를 가집니다. CPU에는 여러가지 범용 레지스터, 스택 포인터를 보관할 레지스터, 조건 플래그를 저장하는 레지스터 세트 등이 있습니다. IR은 다른 플랫폼의 레지스터에 일관되고 추상화 된 인터페이스를 제공합니다. 특히, VEX는 레지스터를 정수 오프셋을 갖는 별도의 메모리 공간으로 모델링합니다.(예를 들어, AMD64의 rax는 메모리 공간의 어드레스 16에서 시작하여 저장)
* **Memory access**. 다른 아키텍처는 각기 다른 방식으로 메모리에 엑세스합니다. 예를 들어 ARM은 리틀 엔디안 및 빅 엔디안 모드로 메모리에 엑세스 할 수 있습니다. IR은 이러한 차이를 추상화하여 진행합니다.
* **Memory segmentation**. x86과 같은 일부 아키텍처는 특수한 세그먼트 레지스터를 이용하여 메모리 분할을 지원합니다. IR은 이러한 메모리 액세스 메커니즘을 이해하며 진행합니다.
* **Instruction side-effects**. 대부분의 instruction에는 side-effect를 가지고 있습니다. 예를 들어 ARM에서 Thumb 모드의 대부분의 연산은 조건 플래그를 업데이트하고 push/pop 명령은 스택 포인터를 업데이트합니다. 분석할 때 이러한 side-effect를 임시 방편으로 추적하는 것은 말도 안되는 일이기 때문에 IR은 이러한 영향을 확실하게 만듭니다.
IR에는 많은 선택 사항이 있습니다. 우리는 VEX를 사용하는데, 바이너리 코드를 VEX로 올리는 것이 매우 잘 되어 있기 때문입니다. VEX는 여러 아키텍처를 지원하며, 기계어 타겟의 수를 표현하는데 부작용이 없습니다. 이는 기계어 코드를 프로그램 분석을 쉽게 하기 위한 표현으로 추상화시켜줍니다. 이 표현에는 네 가지 주요 클래스의 객체가 있습니다.

* **Expressions**. IR 표현식은 계산된 값 또는 상수 값을 나타냅니다. 여기에는 메모리 로드, 레지스터 읽기 및 산술 연산 결과가 포함됩니다.
* **Operations**. IR 오퍼레이션은 IR 표현식의 수정을 설명합니다. 여기에는 정수 산술, 부동 소수점 산술, 비트 연산 등이 포함됩니다. IR 표현식에 적용된 IR 연산은 결과적으로 IR 표현식을 산출해냅니다.
* **Temporary variables**. VEX는 임시 변수를 내부 레지스터로 사용합니다. IR 표현식은 사용 시 임시 변수에 저장됩니다. 임시 변수의 내용은 IR 표현식을 사용하여 검색할 수 있습니다. 이 때 t0부터 시작하여 번호가 매겨집니다. 이러한 임시 변수는 확실한 타입으로 정의됩니다.(e.g. "64-bit integer" 또는 "32-bit float" 등)
* **Statements**. IR문은 메모리 저장 및 레지스터 쓰기에 영향을 미치는 대상 시스템의 상태 변화를 모델링합니다. IR문은 필요할만한 값에 IR 표현식을 사용합니다. 예를 들어, 메모리를 저장하는 IR 표현식은 쓰기 대상 주소에 대해 IR 표현식을 사용하고, 내용에 대해 다른 IR 표현식을 사용합니다.
* **Blocks**. IR 블록은 대상 아키텍쳐에서 extended basic block("IR Super Block" 또는 "IRSB"로 표기)을 나타내는 IR문의 모음입니다. 블록에는 여러개의 exit가 포함될 수 있습니다. basic block 중간중간에서 조건부 exit문의 경우 특별한 Exit IR문이 사용됩니다. IR 표현식은 블록 끝의 무조건 종료 대상을 나타내는데 사용됩니다.

VEX IR은 실제로 VEX 저장소의 `libvex_ir.h` 파일 ([https://github.com/angr/vex/blob/master/pub/libvex_ir.h](https://github.com/angr/vex/blob/master/pub/libvex_ir.h))에 자세히 나와있습니다.

### Condition flags computation (for x86 and ARM)

x86 및 ARM CPU에서 가장 일반적인 instruction side-effect중 하나는 zero flag, carry flag, overflow flag와 같은 조건 플래그를 업데이트하는 것입니다. 컴퓨터 설계자는 일반적으로 특수 레지스터(x86에서는 `EFLAGS`/`RFLAGS`, ARM에서는 `APSR`/`CPSR`)에 이런 플래그를 연결시킵니다.(각 조건 플래그가 1비트에 해당하기 때문에 플래그를 연결) 이 특수 레지스터는 프로그램 상태에 대한 중요한 정보를 저장하며, CPU의 올바른 에뮬레이션에서 중요한 역할을 합니다.

